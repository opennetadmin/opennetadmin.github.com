<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="AUTHOR" content="matt@opennetadmin.com">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="KEYWORDS" content="ona opennetadmin forum archive">
    <meta name="description" content="Old OpenNetAdmin forum archive topic page Trouble shooting Orphaned Record OpenNetAdmin Forum Archive">


    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>Trouble shooting Orphaned Record - OpenNetAdmin Forum Archive</title>
<script type="text/javascript" src="../jquery.js"></script> <script type="text/javascript" src="../jquery.tablesorter.js"></script> <script type="text/javascript" src="../forum.js"></script>
  </head>

  <body onload="load('forum')">
    <a id="forkme_banner" href="https://github.com/opennetadmin"></a>
    <a id="fishes" href="http://www.christiananswers.net/gospel/home.html"><img style="opacity: 0.3;border: 0 none;" src="/images/fish.gif" height="15"></a>
<form id="donatebutton" action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <h1 id="project_title">OpenNetAdmin</h1>
          <h2 id="project_tagline">Track. Automate. Configure.</h2>
          <center>
            <a class="header_link" href="/">Home</a>
            <a class="header_link" href="/features.html">Features</a>
            <a class="header_link" href="/community.html">Community</a>
            <a class="header_link" href="/develop.html">Develop</a>
          </center>
          <section id="downloads">
            <a class="tar_download_link" href="https://github.com/opennetadmin/ona/tarball/current">Download this project as a tar.gz file</a>
          </section>
        </header>
    </div>

       <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner" style="max-width: 730px">


<div class="breadcrumb">
	<p><a href="../index.html">Forums Archive Home</a> &raquo; <a href="index.html">General Discussion</a></p>
</div>

<h1>Trouble shooting Orphaned Record</h1>

<div class="post ">
	<div class="info">
		<p class="poster">druwoldt</p>
		<p class="dt">24-05-2010 17:27:32</p>
	</div>
	<div class="msg">
	<!-- BEGIN MESSAGE -->
	Dear All,<br />
<br />
Had a problem where a domain would not build recently. This is how I worked through it.<br />
<br />
Note ONA is installed in /opt/ona on Red Hat server.<br />
<br />
First I created a test_build script and placed this /opt/ona/bin<br />
<br />
#!/bin/sh<br />
#<br />
# test_build<br />
# Script to list domains, build a selected domain.<br />
#<br />
<br />
ONABASE=`cat /etc/onabase`<br />
ONA_PATH=&quot;/var/named/chroot/var/named&quot;<br />
DCM_PATH=&quot;${ONABASE}/bin/dcm.pl -l sys_build&quot;<br />
SRV_FQDN=`/bin/hostname -f`<br />
<br />
case &quot;$1&quot; in<br />
   list)<br />
      DOMAIN_LIST=`$DCM_PATH -r build_bind_server_domain_list server=$SRV_FQDN`<br />
      for DOMAIN in `echo $DOMAIN_LIST`<br />
      do<br />
         echo $DOMAIN<br />
      done<br />
      ;;<br />
   build)<br />
      echo &quot;Building $2&quot;<br />
      $DCM_PATH -r build_bind_domain domain=$2<br />
      ;;<br />
   *)<br />
      echo $&quot;Usage: $0 {list|build &lt;domain name&gt;}&quot;<br />
      exit 1<br />
esac<br />
<br />
exit 0<br />
<br />
So <br />
cd /opt/ona/bin/<br />
Run test_build list which returned<br />
&lt;domain1&gt;<br />
&lt;domain2&gt;<br />
<br />
I then ran test_build build &lt;domain2&gt; which returned the following error<br />
ERROR =&gt; Unable to find interface record 490 with name  and notes !<br />
<br />
Next I got a list of the ONA tables<br />
<br />
./dcm.pl -r ona_sql sql=&quot;show tables;&quot;<br />
<br />
Tables_in_ona<br />
blocks<br />
configuration_types<br />
configurations<br />
contexts<br />
custom_attribute_types<br />
custom_attributes<br />
dcm_module_list<br />
defaults<br />
device_types<br />
devices<br />
dhcp_failover_groups<br />
dhcp_option_entries<br />
dhcp_options<br />
dhcp_pools<br />
dhcp_server_subnets<br />
dns<br />
dns_server_domains<br />
domains<br />
group_assignments<br />
groups<br />
host_roles<br />
hosts<br />
interface_clusters<br />
interfaces<br />
locations<br />
manufacturers<br />
messages<br />
models<br />
permission_assignments<br />
permissions<br />
roles<br />
sequences<br />
sessions<br />
subnet_types<br />
subnets<br />
sys_config<br />
users<br />
vlan_campuses<br />
vlans<br />
<br />
As the error mention an interface record. We first find out about this table.<br />
./dcm.pl -r ona_sql sql=&quot;desc interfaces;&quot;<br />
Field:Type:Null:Key:Default:Extra<br />
id:int(10) unsigned:NO:PRI::<br />
subnet_id:int(10) unsigned:NO:::<br />
host_id:int(10) unsigned:NO:::<br />
nat_interface_id:int(10) unsigned:NO::0:<br />
ip_addr:int(10) unsigned:NO:::<br />
mac_addr:varchar(12):NO:::<br />
name:varchar(255):NO:::<br />
description:varchar(255):YES:::<br />
last_response:timestamp:YES:::<br />
<br />
Now we search based on the id field for 490<br />
./dcm.pl -r ona_sql sql=&quot;select * from interfaces where id=490;&quot;<br />
NOTICE =&gt; SQL executed successfully - no records returned<br />
<br />
So no record exists. This is where the problem is but what DNS record references this. Next look at the dns table structure.<br />
./dcm.pl -r ona_sql sql=&quot;desc dns;&quot;<br />
Field:Type:Null:Key:Default:Extra<br />
id:int(10) unsigned:NO:PRI::<br />
domain_id:int(10) unsigned:NO:::<br />
interface_id:int(10) unsigned:NO:::<br />
dns_id:int(10) unsigned:NO::0:<br />
type:varchar(15):NO:::<br />
ttl:int(10) unsigned:NO:::<br />
name:varchar(255):NO:::<br />
ebegin:timestamp:NO::CURRENT_TIMESTAMP:<br />
notes:varchar(128):NO:::<br />
mx_preference:tinyint(5) unsigned:NO:::<br />
txt:varchar(255):NO:::<br />
srv_pri:smallint(5) unsigned:NO:::<br />
srv_weight:smallint(5) unsigned:NO:::<br />
srv_port:smallint(5) unsigned:NO:::<br />
<br />
From this we can see that the dns table references interfaces using interface_id. So we look for interface_id = 490 on the dns table.<br />
./dcm.pl -r ona_sql sql=&quot;select * from dns where interface_id=490;”<br />
id:domain_id:interface_id:dns_id:type:ttl:name:ebegin:notes:mx_preference:txt:srv_pri:srv_weight:srv_port<br />
1016:5:490:998:PTR:0::2010-05-18 10:32:20::0::0:0:0<br />
<br />
So 1016 points to interface 490 which does not exist.<br />
<br />
But what does 1016 belong to.<br />
Under dns_id we can see another dns_id. If we look up this one<br />
./dcm.pl -r ona_sql sql=&quot;select * from dns where id=998;”<br />
id:domain_id:interface_id:dns_id:type:ttl:name:ebegin:notes:mx_preference:txt:srv_pri:srv_weight:srv_port<br />
998:1:481:0:A:0:server1:2010-05-18 10:31:01::0::0:0:0<br />
<br />
So we can see that the PTR records belong to server1. As can been seen the dns_id=0 means there are no further links.<br />
<br />
So now we search to see if there are any other records for 998<br />
./dcm.pl -r ona_sql sql=&quot;select * from dns where dns_id=998;”<br />
id:domain_id:interface_id:dns_id:type:ttl:name:ebegin:notes:mx_preference:txt:srv_pri:srv_weight:srv_port<br />
999:5:481:998:PTR:0::2010-05-18 09:43:00::0::0:0:0<br />
1016:5:490:998:PTR:0::2010-05-18 10:32:20::0::0:0:0<br />
1017:5:491:998:PTR:0::2010-05-18 10:32:28::0::0:0:0<br />
1024:5:497:998:PTR:0::2010-05-24 14:17:57::0::0:0:0<br />
<br />
So we can see there are 4 records that hold pointers for 998. If we do checks on the interfaces table we find that 481 exists, 490, 491 and 497 do not exist. This means 1016,1017 and 1024 need to be removed from the dns table. As you can not use dcm.pl to remove records you will need to use mysql client to connect directly to the database.<br />
<br />
mysql –u root –p<br />
&lt;enter password&gt;<br />
connect ona<br />
DELETE FROM dns WHERE id=1016;<br />
DELETE FROM dns WHERE id=1017;<br />
DELETE FROM dns WHERE id=1024;<br />
COMMIT;<br />
Exit;<br />
<br />
Now try a test_build again. If you get the build data returned, ie a long list of <br />
1.1.2.10.in-addr.arpa.                                    IN  PTR      server-44.dummy.com.<br />
2.1.2.10.in-addr.arpa.                                    IN  PTR      server-45.dummy.com.<br />
<br />
Then the build is successful.<br />
<br />
Hope this is helpful.<br />
<br />
Yours sincerely<br />
<br />
David Ruwoldt	<!-- END MESSAGE -->
	</div>
</div>
<div class="post ">
	<div class="info">
		<p class="poster">Matt</p>
		<p class="dt">24-05-2010 19:27:08</p>
	</div>
	<div class="msg">
	<!-- BEGIN MESSAGE -->
	druwoldt,<br />
<br />
Excellent troubleshooting information.. Thanks for posting it.   Now all I need to do is find out why ONA allowed the orphan records and hopefully people wont have to run into what you did. <br />
<br />
This is great info for people to understand a bit more about how to use the dcm.pl tool as well as basic structure of the tables.	<!-- END MESSAGE -->
	</div>
</div>
<div class="post ">
	<div class="info">
		<p class="poster">druwoldt</p>
		<p class="dt">24-05-2010 19:36:21</p>
	</div>
	<div class="msg">
	<!-- BEGIN MESSAGE -->
	Dear Matt,<br />
<br />
Hit orphaned record again. What happened<br />
1) Create interface that also creates PTR<br />
2) Delete interface but PTR remains (or maybe I do not wait for GUI to update)<br />
3) Select delete on PTR record<br />
<br />
This is the second time this has happened to me. So not sure if deleting interface that has associated PTR causes it or my impatience <!-- s:) --><img src="{SMILIES_PATH}/icon_e_smile.gif" alt=":)" title=":-)" /><!-- s:) -->.<br />
<br />
Yours sincerely<br />
<br />
David Ruwoldt	<!-- END MESSAGE -->
	</div>
</div>
<div class="post ">
	<div class="info">
		<p class="poster">Matt</p>
		<p class="dt">24-05-2010 21:58:19</p>
	</div>
	<div class="msg">
	<!-- BEGIN MESSAGE -->
	Great catch.. I have found the bug in the code itself.. now I gotta fix it up.  I can't believe I've not run into this one before!.. <br />
<br />
I'll try and fix it up shortly.. Thanks for the info.	<!-- END MESSAGE -->
	</div>
</div>
</section></div>



<div id="stupid_ads" align="center">
<script type="text/javascript"><!--
google_ad_client = "pub-2598149030041038";
//728x90_bugsfooter
google_ad_slot = "1568593938";
google_ad_width = 728;
google_ad_height = 90;
//--></script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>

    <!-- FOOTER  -->
    <div class="outer">
      <footer class="inner">
          <center>
 


          </center>
      </footer>
    </div>

          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script
%3E"));
          </script>

          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-361894-3");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>


